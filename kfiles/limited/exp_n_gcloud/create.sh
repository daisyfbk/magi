#!/bin/bash

gcloud beta container --project "$GCP_PROJECT_NAME" clusters create "$GCP_CLUSTER_NAME" --zone "$GCP_ZONE" --tier "standard" --no-enable-basic-auth --cluster-version "$GCP_CLUSTER_VERSION" --release-channel "regular" --machine-type "e2-standard-2" --image-type "UBUNTU_CONTAINERD" --disk-type "pd-balanced" --disk-size "60" --metadata disable-legacy-endpoints=true --num-nodes "8" --logging=SYSTEM,WORKLOAD,API_SERVER --monitoring=SYSTEM,STORAGE,POD,DEPLOYMENT,STATEFULSET,DAEMONSET,HPA,JOBSET,CADVISOR,KUBELET,DCGM,API_SERVER --enable-ip-alias --network "projects/$PROJECT_NAME/global/networks/default" --subnetwork "projects/$GCP_PROJECT_NAME/regions/$GCP_REGION/subnetworks/default" --enable-intra-node-visibility --default-max-pods-per-node "110" --enable-ip-access --security-posture=standard --workload-vulnerability-scanning=disabled --enable-dataplane-v2 --enable-dataplane-v2-metrics --enable-dataplane-v2-flow-observability --enable-master-authorized-networks --master-authorized-networks "$ALLOWED_IPS" --no-enable-google-cloud-access --addons HorizontalPodAutoscaling,HttpLoadBalancing,GcePersistentDiskCsiDriver --enable-autoupgrade --enable-autorepair --max-surge-upgrade 1 --max-unavailable-upgrade 0 --binauthz-evaluation-mode=DISABLED --enable-managed-prometheus --enable-shielded-nodes --shielded-integrity-monitoring --no-shielded-secure-boot --node-locations "$GCP_ZONE"

gcloud compute instances create prometheus --project="$GCP_PROJECT_NAME" --zone="$GCP_PROM_ZONE" --machine-type=e2-medium --network-interface=network-tier=PREMIUM,stack-type=IPV4_ONLY,subnet=default --maintenance-policy=MIGRATE --provisioning-model=STANDARD --service-account="$GCP_SERVICE_ACCOUNT" --scopes=https://www.googleapis.com/auth/devstorage.read_only,https://www.googleapis.com/auth/logging.write,https://www.googleapis.com/auth/monitoring.write,https://www.googleapis.com/auth/service.management.readonly,https://www.googleapis.com/auth/servicecontrol,https://www.googleapis.com/auth/trace.append --tags=https-server,http-server --create-disk=auto-delete=yes,boot=yes,device-name=prometheus,image=projects/ubuntu-os-cloud/global/images/ubuntu-minimal-2504-plucky-amd64-v20250708,mode=rw,size=50,type=pd-standard --no-shielded-secure-boot --shielded-vtpm --shielded-integrity-monitoring --labels=goog-ec-src=vm_add-gcloud --reservation-affinity=any && gcloud compute resource-policies create snapshot-schedule default-schedule-1 --project=$GCP_PROJECT_NAME --region=europe-west10 --max-retention-days=14 --on-source-disk-delete=keep-auto-snapshots --daily-schedule --start-time=06:00 && gcloud compute disks add-resource-policies prometheus --project=$GCP_PROJECT_NAME --zone="$GCP_PROM_ZONE" --resource-policies=projects/$GCP_PROJECT_NAME/regions/europe-west10/resourcePolicies/default-schedule-1

# Then, over ssh
# scp -i ~/.ssh/google_compute_engine prometheus-2.53.5.linux-amd64.tar.gz matte@prometheus:~/
# ssh -i ~/.ssh/google_compute_engine matte@prometheus 'sudo apt update; sudo apt install iputils-ping golang rsync zsh -y; go install github.com/go-pluto/styx@latest'